<form id='ai_scan_agent_dashboard' platforms='web' dashboard='true' menuName='Job_Management' title='' menuOrder='hidden' style='{styles.sylFormUserManagement}' xmlns='http://schemas.mobilengine.com/fls/v2'>
    <declarations>
        <let id='stLoggedUserId' shape='scalar' value='{
            SELECT
                U.id
            FROM
                ai_scan_user U
            WHERE
                U.email = sysp.user
        }'/>
        <let id='stLoggedUserRole' shape='scalar' value='{
            SELECT
                U.role
            FROM
                ai_scan_user U
            WHERE
                U.email = sysp.user
        }'/>
        <let id='stLoggedUserStatus' shape='scalar' value='{
            SELECT
                U.status
            FROM
                ai_scan_user U
            WHERE
                U.email = sysp.user
        }'/>
        <let id='iOtherOnlineUsers' shape='scalar' value='{
            SELECT
                COUNT(U.id)
            FROM
                ai_scan_user U
            WHERE
                U.status = "ONLINE"
                AND U.id != stLoggedUserId
        }'/>
        <let id='ltblAllUnassignedJobs' shape='table' access='private' 
			value='{loadNewerFromServer:SELECT
                        J.id,
                        DNJ.id delivery_id,
                        DNJ.delivery_note_id,
						DNJ.supplier_id,
                        J.type job_type,
                        CASE J.status
                            WHEN "INPROGRESS" THEN 1
                            WHEN "UNCHECKED" THEN 2
                            ELSE 3 
                        END iStatusOrder,
                        CASE J.type
                            WHEN "QA" THEN 1
                            ELSE 2 
                        END iOrder,
                        J.job_create_date create_date
					FROM
                        ai_scan_delivery_note_job DNJ
                    LEFT JOIN 
                        ai_scan_jobs J ON J.id = DNJ.job_id
                    LEFT JOIN 
                        ai_scan_jobs_history JH ON JH.id = J.id
					WHERE
                        CASE WHEN iOtherOnlineUsers > 2 AND J.type = "ANOT" THEN JH.users NOT LIKE "%" || stLoggedUserId || "%" WHEN iOtherOnlineUsers > 3 AND J.type = "QA" THEN JH.users NOT LIKE "%" || stLoggedUserId || "%" ELSE JH.current_user = "NULL" END
                    GROUP BY DNJ.id, DNJ.delivery_note_id
                    HAVING COUNT(DNJ.id) >1
                    ORDER BY
                        iStatusOrder,
                        iOrder,
                        create_date ASC}'
		/>
        <let id='ltblLoggedUserJobs' shape='table' access='private' 
			value='{loadNewerFromServer:SELECT
                        J.id,
                        DNJ.id delivery_id,
                        DNJ.delivery_note_id,
						DNJ.supplier_id,
                        J.type job_type,
                        CASE J.status
                            WHEN "INPROGRESS" THEN 1
                            WHEN "UNCHECKED" THEN 2
                            ELSE 3
                        END iStatusOrder,
                        CASE J.type
                            WHEN "QA" THEN 1
                            ELSE 2 
                        END iOrder,
                        J.job_create_date create_date
					FROM
                        ai_scan_delivery_note_job DNJ
                    LEFT JOIN 
                        ai_scan_jobs J ON J.id = DNJ.job_id
                    LEFT JOIN 
                        ai_scan_jobs_history JH ON JH.id = J.id
					WHERE
                        JH.current_user = stLoggedUserId
                        AND J.status != "DONE"
                    ORDER BY
                        iStatusOrder,
                        iOrder,
                        create_date ASC
                    LIMIT 1}'
		/>
        <let id='iJobCount' shape='scalar' access='private' value='{loadNewerFromServer:SELECT COUNT(0) FROM ltblAllUnassignedJobs AUJ}'/>
        <let id='iLoggedUserJobCount' shape='scalar' value='{SELECT COUNT(0) FROM ltblLoggedUserJobs LUJ}'/>
        <let id='stLoggedUserSelectedJobId' shape='scalar' value='{SELECT LUJ.id FROM ltblLoggedUserJobs LUJ}'/>
        <let id='stLoggedUserSelectedJobType' shape='scalar' value='{SELECT LUJ.job_type FROM ltblLoggedUserJobs LUJ}'/>
        <let id='stLoggedUserSelectedJobDeliveryId' shape='scalar' value='{SELECT LUJ.delivery_id FROM ltblLoggedUserJobs LUJ}'/>
        <let id='stLoggedUserSelectedJobDeliveryNoteId' shape='scalar' value='{SELECT LUJ.delivery_note_id FROM ltblLoggedUserJobs LUJ}'/>
        <let id='stLoggedUserSelectedJobSupplierId' shape='scalar' access='private' value='{SELECT LUJ.supplier_id FROM ltblLoggedUserJobs LUJ}'/>
        <let id='stInstanceUrl' shape='scalar' access='private' value='{SELECT "https://scanbauapp-outdoor.mobilengine.com/"}'/>
        <let id='bChangeOnline' shape='scalar' value='{false}'/>
        <let id='bChangeOffline' shape='scalar' value='{false}'/>
        <let id='bGetJob' shape='scalar' value='{loadNewerFromServer:SELECT false}'/>
        <let id='bCancelCurrentAnotJob' shape='scalar' value='{false}'/>
        <let id='bCancelCurrentQAJob' shape='scalar' value='{false}'/>
    </declarations>

    <header></header>

    <if cond='{stLoggedUserRole = "Coordinator"}'>
        <hbox style='{styles.sylTabsAndSaveButtonHbox}'>
            <submitbutton id='sbtnDashboard' text='Dashboard' nextForm='{forms.ai_scan_coordinator_dashboard}' style='{styles.sylTabInActive}' testId='sbtnDashboard'/>
            <submitbutton id='sbtnAgent' text='Agent' nextForm='{forms.ai_scan_agent_dashboard}' style='{styles.sylTabActive}' testId='sbtnAgent'/>
            <submitbutton id='sbtnSetting' text='Setting' nextForm='{forms.ai_scan_setting}' style='{styles.sylTabInActive}' testId='sbtnSetting'/>
            <textview text=''/>
            <submitbutton id='sbtnSave' text='Save' nextForm='{forms.ai_scan_setting}' style='{styles.sylSbtnSave}' testId='sbtnSave'/>
        </hbox>
    </if>

    <textview id='tvTitle' text='Data entry dashboard' style='{styles.sylTvTitle}' testId='tvTitle'/>

    <if cond='{stLoggedUserStatus = "OFFLINE"}'>
        <combinedbutton id='cbtnStatusChangeOnline' text='I am offline' style='{styles.sylCbtnStatusChangeOnline}' testId='cbtnStatusChangeOnline'>
            <actionbutton>
                <set target='bChangeOnline' value='{true}'/>
                <set target='bChangeOffline' value='{false}'/>
                <set target='bGetJob' value='{false}'/>
                <set target='bCancelCurrentAnotJob' value='{false}'/>
                <set target='bCancelCurrentQAJob' value='{false}'/>
            </actionbutton>
            <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
        </combinedbutton>
    </if>

    <if cond='{stLoggedUserStatus = "ONLINE"}'>
        <combinedbutton id='cbtnStatusChangeOffline' text='I am online' style='{styles.sylCbtnStatusChangeOffline}' testId='cbtnStatusChangeOffline'>
            <actionbutton>
                <set target='bChangeOnline' value='{false}'/>
                <set target='bChangeOffline' value='{true}'/>
                <set target='bGetJob' value='{false}'/>
                <set target='bCancelCurrentAnotJob' value='{false}'/>
                <set target='bCancelCurrentQAJob' value='{false}'/>
            </actionbutton>
            <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
        </combinedbutton>        
    </if>

    <if cond='{stLoggedUserStatus = "OFFLINE" OR (stLoggedUserStatus != "OFFLINE" AND iJobCount = 0 AND iLoggedUserJobCount = 0)}'>
        <textview id='tvNoJob' text='No pending jobs' style='{styles.sylTvNoJob}' testId='tvNoJob'/>
    </if>

    <if cond='{stLoggedUserStatus != "OFFLINE" AND iJobCount != 0 AND NOT bGetJob}'>
        <combinedbutton id='cbtnGetJob' text='You have pending jobs' style='{styles.sylCbtnGetJob}' testId='cbtnGetJob'>
            <actionbutton>
                <set target='bChangeOnline' value='{false}'/>
                <set target='bChangeOffline' value='{false}'/>
                <set target='bGetJob' value='{true}'/>
                <set target='bCancelCurrentAnotJob' value='{false}'/>
                <set target='bCancelCurrentQAJob' value='{false}'/>
            </actionbutton>
            <submitbutton closeForm='{false}' waitForRfs='{true}'/>
        </combinedbutton>
    </if>

    <if cond='{stLoggedUserStatus != "OFFLINE" AND iLoggedUserJobCount != 0 AND bGetJob AND stLoggedUserSelectedJobType != "QA"}'>
        <hbox style='{styles.sylStartLinkviewAndCancelButtonHbox}'>
            <linkview id='lvStartAnotJob' text='Click here to start annotation' url='https://www.google.com/' linkIcon='{NULL}' style='{styles.sylLvStartLinkview}' testId='lvStartAnotJob'/>
            <combinedbutton id='cbtnCancelAnotJob' text='Cancel' style='{styles.sylCbtnCancelJob}' testId='cbtnCancelAnotJob'>
                <actionbutton>
                    <set target='bChangeOnline' value='{false}'/>
                    <set target='bChangeOffline' value='{false}'/>
                    <set target='bGetJob' value='{false}'/>
                    <set target='bCancelCurrentAnotJob' value='{true}'/>
                    <set target='bCancelCurrentQAJob' value='{false}'/>
                </actionbutton>
                <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
            </combinedbutton>
        </hbox>
        <textview id='tvAnotInfo' text='{"You are working on delivery note: " || CASE WHEN stLoggedUserSelectedJobSupplierId = "" OR stLoggedUserSelectedJobSupplierId = null THEN "Delivery note number not available" ELSE stLoggedUserSelectedJobSupplierId END}' style='{styles.sylTvInfo}' testId='tvAnotInfo'/>
    </if>

    <if cond='{stLoggedUserStatus != "OFFLINE" AND iLoggedUserJobCount != 0 AND bGetJob AND stLoggedUserSelectedJobType = "QA"}'>
        <hbox style='{styles.sylStartLinkviewAndCancelButtonHbox}'>
            <linkview id='lvStartQAJob' text='Click here to start QA job' url='{stInstanceUrl || "webforms/Form/ai_scan_qa_job?QAJobId=" || stLoggedUserSelectedJobId}' linkIcon='{NULL}' style='{styles.sylLvStartLinkview}' testId='lvStartQAJob'/>
            <combinedbutton id='cbtnCancelQAJob' text='Cancel' style='{styles.sylCbtnCancelJob}' testId='cbtnCancelQAJob'>
                <actionbutton>
                    <set target='bChangeOnline' value='{false}'/>
                    <set target='bChangeOffline' value='{false}'/>
                    <set target='bGetJob' value='{false}'/>
                    <set target='bCancelCurrentAnotJob' value='{false}'/>
                    <set target='bCancelCurrentQAJob' value='{true}'/>
                </actionbutton>
                <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
            </combinedbutton>
        </hbox>
        <textview id='tvQAInfo' text='{"You are working on delivery note: " || CASE WHEN stLoggedUserSelectedJobSupplierId = "" OR stLoggedUserSelectedJobSupplierId = null THEN "Delivery note number not available" ELSE stLoggedUserSelectedJobSupplierId END}' style='{styles.sylTvInfo}' testId='tvQAInfo'/>
    </if>
    
</form>