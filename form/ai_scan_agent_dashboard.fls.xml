<form id='ai_scan_agent_dashboard' platforms='web' dashboard='true' menuName='Job_Management' title='' menuOrder='hidden' style='{styles.sylFormUserManagement}' xmlns='http://schemas.mobilengine.com/fls/v2'>
    <declarations>
        <let id='stLoggedUserId' shape='scalar' value='{
            SELECT
                U.id
            FROM
                ai_scan_user U
            WHERE
                U.email = sysp.user
        }'/>
        <let id='stLoggedUserAnotLanguage' shape='scalar' value='{
            SELECT
                CASE WHEN UL.anot_job_language IS NULL THEN "" ELSE UL.anot_job_language END
            FROM
                ai_scan_user_language UL
            WHERE
                UL.user_id = stLoggedUserId
        }'/>
        <let id='stLoggedUserQALanguage' shape='scalar' value='{
            SELECT
                CASE WHEN UL.qa_job_language IS NULL THEN "" ELSE UL.qa_job_language END
            FROM
                ai_scan_user_language UL
            WHERE
                UL.user_id = stLoggedUserId
        }'/>
        <let id='stLoggedUserRole' shape='scalar' value='{
            SELECT
                U.role
            FROM
                ai_scan_user U
            WHERE
                U.email = sysp.user
        }'/>
        <let id='stLoggedUserStatus' shape='scalar' value='{
            SELECT
                U.status
            FROM
                ai_scan_user U
            WHERE
                U.email = sysp.user
        }'/>
        <let id='iOtherOnlineUsers' shape='scalar' value='{
            SELECT
                COUNT(U.id)
            FROM
                ai_scan_user U
            WHERE
                U.status = "ONLINE"
                AND U.id != stLoggedUserId
        }'/>
        <let id='ltblCurrentUserJobAvaiableInAllUnassignedJobs' shape='table' access='private' 
			value='{loadNewerFromServer: SELECT 
                        J.id current_job,
                        J.current_user current_job_current_user,
                        J.language_type,
                        J.job_id_2 job1,
                        J.job_id_3 job2,
                        DNJ.delivery_note_id,
                        DNJ.supplier_id,
                        J.type job_type,
                        CASE J.status
                            WHEN "INPROGRESS" THEN 1
                            WHEN "UNCHECKED" THEN 2
                            ELSE 3 
                        END iStatusOrder,
                        CASE J.type
                            WHEN "QA" THEN 1
                            ELSE 2 
                        END iOrder,
                        J.create_date create_date,
                        J.delay_time 
                    FROM 
                        (
                        SELECT 
                            J2.id,
                            J2.current_user,
                            J2.language_type,
                            J2.job_id_2,
                            J2.job_id_3,
                            J2.type,
                            J2.status,
                            J2.create_date,
                            J2.delay_time
                        FROM 
                            ai_scan_jobs J2 
                        WHERE 
                            CASE
                                WHEN J2.type = "QA" AND 
                                J2.status = "UNCHECKED" AND 
                                J2.job_id_2 NOT IN (SELECT J3.id FROM ai_scan_jobs J3 WHERE J3.current_user = stLoggedUserId) AND
                                J2.job_id_3 NOT IN (SELECT J3.id FROM ai_scan_jobs J3 WHERE J3.current_user = stLoggedUserId) 
                                THEN true
                                WHEN J2.type = "ANOT" 
                                THEN J2.job_id_2 NOT IN (SELECT J3.id FROM ai_scan_jobs J3 WHERE J3.current_user = stLoggedUserId)
                            END = true
                        ) J
                    LEFT JOIN
                        ai_scan_delivery_note_job DNJ ON DNJ.job_id = J.id 
                    WHERE
                        (J.delay_time IS NULL OR J.delay_time &lt; sysp.dtlFormOpen) AND
                        ((J.type = "QA" AND stLoggedUserQALanguage LIKE "%" || J.language_type || "%") OR (J.type = "ANOT" AND stLoggedUserAnotLanguage LIKE "%" || J.language_type || "%")) AND 
                        J.id NOT IN (SELECT J3.id FROM ai_scan_jobs J3 WHERE J3.current_user = stLoggedUserId)}'
		/>
        <let id='ltblLoggedUserJobs' shape='table' access='private' 
			value='{loadNewerFromServer: SELECT
                        J.id current_job,
                        J.current_user current_job_current_user,
                        J.job_id_2 job1,
                        J.job_id_3 job2,
                        DNJ.delivery_note_id,
                        DNJ.supplier_id,
                        J.type job_type,
                        CASE J.status
                            WHEN "INPROGRESS" THEN 1
                            WHEN "UNCHECKED" THEN 2
                            ELSE 3 
                        END iStatusOrder,
                        CASE J.type
                            WHEN "QA" THEN 1
                            ELSE 2 
                        END iOrder,
                        J.create_date create_date
					FROM
                        ai_scan_delivery_note_job DNJ
                    LEFT JOIN 
                        ai_scan_jobs J ON J.id = DNJ.job_id
					WHERE
                        J.current_user = stLoggedUserId
                        AND J.status != "DONE"
                    ORDER BY
                        iStatusOrder,
                        iOrder,
                        create_date ASC
                    LIMIT 1}'
		/>
        <let id='iJobCount' shape='scalar' access='private' value='{SELECT COUNT(0) FROM ltblCurrentUserJobAvaiableInAllUnassignedJobs AUJ}'/>
        <let id='iLoggedUserJobCount' shape='scalar' value='{SELECT COUNT(0) FROM ltblLoggedUserJobs LUJ}'/>
        <let id='stLoggedUserSelectedJobId' shape='scalar' value='{SELECT LUJ.current_job FROM ltblLoggedUserJobs LUJ}'/>
        <let id='stLoggedUserSelectedJobType' shape='scalar' value='{SELECT LUJ.job_type FROM ltblLoggedUserJobs LUJ}'/>
        <let id='stLoggedUserSelectedJobDeliveryNoteId' shape='scalar' value='{SELECT LUJ.delivery_note_id FROM ltblLoggedUserJobs LUJ}'/>
        <let id='stLoggedUserSelectedJobSupplierId' shape='scalar' access='private' value='{SELECT LUJ.supplier_id FROM ltblLoggedUserJobs LUJ}'/>
        <let id='bChangeOnline' shape='scalar' value='{false}'/>
        <let id='bChangeOffline' shape='scalar' value='{false}'/>
        <let id='bGetJob' shape='scalar' value='{loadNewerFromServer: SELECT false}'/>
        <let id='bCancelCurrentAnotJob' shape='scalar' value='{false}'/>
        <let id='bCancelDelayCurrentAnotJob' shape='scalar' value='{false}'/>
        <let id='bCancelCurrentQAJob' shape='scalar' value='{false}'/>
        <let id='bCancelDelayCurrentQAJob' shape='scalar' value='{false}'/>
    </declarations>

    <header></header>

    <if cond='{stLoggedUserRole = "Coordinator"}'>
        <hbox style='{styles.sylTabsAndSaveButtonHbox}'>
            <submitbutton id='sbtnDashboard' text='Dashboard' nextForm='{forms.ai_scan_coordinator_dashboard}' style='{styles.sylTabInActive}' testId='sbtnDashboard'/>
            <submitbutton id='sbtnAgent' text='Agent' nextForm='{forms.ai_scan_agent_dashboard}' style='{styles.sylTabActive}' testId='sbtnAgent'/>
            <submitbutton id='sbtnSetting' text='Setting' nextForm='{forms.ai_scan_setting}' style='{styles.sylTabInActive}' testId='sbtnSetting'/>
            <textview text=''/>
            <submitbutton id='sbtnSave' text='Save' nextForm='{forms.ai_scan_setting}' style='{styles.sylSbtnSave}' testId='sbtnSave'/>
        </hbox>
    </if>

    <textview id='tvTitle' text='Data entry dashboard' style='{styles.sylTvTitle}' testId='tvTitle'/>

    <if cond='{stLoggedUserStatus = "OFFLINE"}'>
        <combinedbutton id='cbtnStatusChangeOnline' text='I am offline' style='{styles.sylCbtnStatusChangeOnline}' testId='cbtnStatusChangeOnline'>
            <actionbutton>
                <set target='bChangeOnline' value='{true}'/>
                <set target='bChangeOffline' value='{false}'/>
                <set target='bGetJob' value='{false}'/>
                <set target='bCancelCurrentAnotJob' value='{false}'/>
                <set target='bCancelDelayCurrentAnotJob' value='{false}'/>
                <set target='bCancelCurrentQAJob' value='{false}'/>
                <set target='bCancelDelayCurrentQAJob' value='{false}'/>
            </actionbutton>
            <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
        </combinedbutton>
    </if>

    <if cond='{stLoggedUserStatus = "ONLINE"}'>
        <combinedbutton id='cbtnStatusChangeOffline' text='I am online' style='{styles.sylCbtnStatusChangeOffline}' testId='cbtnStatusChangeOffline'>
            <actionbutton>
                <set target='bChangeOnline' value='{false}'/>
                <set target='bChangeOffline' value='{true}'/>
                <set target='bGetJob' value='{false}'/>
                <set target='bCancelCurrentAnotJob' value='{false}'/>
                <set target='bCancelDelayCurrentAnotJob' value='{false}'/>
                <set target='bCancelCurrentQAJob' value='{false}'/>
                <set target='bCancelDelayCurrentQAJob' value='{false}'/>
            </actionbutton>
            <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
        </combinedbutton>        
    </if>

    <if cond='{stLoggedUserStatus = "OFFLINE" OR (stLoggedUserStatus != "OFFLINE" AND iJobCount = 0 AND iLoggedUserJobCount = 0)}'>
        <textview id='tvNoJob' text='No pending jobs' style='{styles.sylTvNoJob}' testId='tvNoJob'/>
    </if>

    <if cond='{stLoggedUserStatus != "OFFLINE" AND iJobCount != 0 AND iLoggedUserJobCount = 0}'>
        <combinedbutton id='cbtnGetJob' text='You have pending jobs' style='{styles.sylCbtnGetJob}' testId='cbtnGetJob'>
            <actionbutton>
                <set target='bChangeOnline' value='{false}'/>
                <set target='bChangeOffline' value='{false}'/>
                <set target='bGetJob' value='{true}'/>
                <set target='bCancelCurrentAnotJob' value='{false}'/>
                <set target='bCancelDelayCurrentAnotJob' value='{false}'/>
                <set target='bCancelCurrentQAJob' value='{false}'/>
                <set target='bCancelDelayCurrentQAJob' value='{false}'/>
            </actionbutton>
            <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
        </combinedbutton>
    </if>

    <if cond='{stLoggedUserStatus != "OFFLINE" AND iLoggedUserJobCount != 0 AND stLoggedUserSelectedJobType != "QA"}'>
        <hbox style='{styles.sylStartLinkviewAndCancelButtonHbox}'>
            <linkview id='lvStartAnotJob' text='Click here to start annotation' url='https://www.google.com/' linkIcon='{NULL}' style='{styles.sylLvStartAnotJob}' testId='lvStartAnotJob'/>
            <combinedbutton id='cbtnCancelAnotJob' text='Cancel' style='{styles.sylCbtnCancelJob}' testId='cbtnCancelAnotJob'>
                <actionbutton>
                    <set target='bChangeOnline' value='{false}'/>
                    <set target='bChangeOffline' value='{false}'/>
                    <set target='bGetJob' value='{false}'/>
                    <set target='bCancelCurrentAnotJob' value='{true}'/>
                    <set target='bCancelDelayCurrentAnotJob' value='{false}'/>
                    <set target='bCancelCurrentQAJob' value='{false}'/>
                    <set target='bCancelDelayCurrentQAJob' value='{false}'/>
                </actionbutton>
                <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
            </combinedbutton>
            <combinedbutton id='cbtnCancelDelayAnotJob' text='Delay with 1 hour' style='{styles.sylCbtnCancelDelayJob}' testId='cbtnCancelDelayAnotJob'>
                <actionbutton>
                    <set target='bChangeOnline' value='{false}'/>
                    <set target='bChangeOffline' value='{false}'/>
                    <set target='bGetJob' value='{false}'/>
                    <set target='bCancelCurrentAnotJob' value='{false}'/>
                    <set target='bCancelDelayCurrentAnotJob' value='{true}'/>
                    <set target='bCancelCurrentQAJob' value='{false}'/>
                    <set target='bCancelDelayCurrentQAJob' value='{false}'/>
                </actionbutton>
                <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
            </combinedbutton>
        </hbox>
        <textview id='tvAnotInfo' text='{"You are working on delivery note: " || CASE WHEN stLoggedUserSelectedJobSupplierId = "" OR stLoggedUserSelectedJobSupplierId = null THEN "Delivery note number not available" ELSE stLoggedUserSelectedJobSupplierId END}' style='{styles.sylTvInfo}' testId='tvAnotInfo'/>
    </if>

    <if cond='{stLoggedUserStatus != "OFFLINE" AND iLoggedUserJobCount != 0 AND stLoggedUserSelectedJobType = "QA"}'>
        <hbox style='{styles.sylStartLinkviewAndCancelButtonHbox}'>
            <submitbutton id='sbtnStartQAJob' text='Click here to start QA job' nextForm='{forms.ai_scan_qa_job}' style='{styles.sylSbtnStartQAJob}' testId='sbtnStartQAJob'>
                <params>
                    <param id='QAJobId' value='{stLoggedUserSelectedJobId}'/>
                </params>
            </submitbutton>
            <combinedbutton id='cbtnCancelQAJob' text='Cancel' style='{styles.sylCbtnCancelJob}' testId='cbtnCancelQAJob'>
                <actionbutton>
                    <set target='bChangeOnline' value='{false}'/>
                    <set target='bChangeOffline' value='{false}'/>
                    <set target='bGetJob' value='{false}'/>
                    <set target='bCancelCurrentAnotJob' value='{false}'/>
                    <set target='bCancelDelayCurrentAnotJob' value='{false}'/>
                    <set target='bCancelCurrentQAJob' value='{true}'/>
                    <set target='bCancelDelayCurrentQAJob' value='{false}'/>
                </actionbutton>
                <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
            </combinedbutton>
            <combinedbutton id='cbtnCancelDelayQAJob' text='Delay with 1 hour' style='{styles.sylCbtnCancelDelayJob}' testId='cbtnCancelDelayQAJob'>
                <actionbutton>
                    <set target='bChangeOnline' value='{false}'/>
                    <set target='bChangeOffline' value='{false}'/>
                    <set target='bGetJob' value='{false}'/>
                    <set target='bCancelCurrentAnotJob' value='{false}'/>
                    <set target='bCancelDelayCurrentAnotJob' value='{false}'/>
                    <set target='bCancelCurrentQAJob' value='{false}'/>
                    <set target='bCancelDelayCurrentQAJob' value='{true}'/>
                </actionbutton>
                <submitbutton nextForm='{forms.ai_scan_agent_dashboard}'/>
            </combinedbutton>
        </hbox>
        <textview id='tvQAInfo' text='{"You are working on delivery note: " || CASE WHEN stLoggedUserSelectedJobSupplierId = "" OR stLoggedUserSelectedJobSupplierId = null THEN "Delivery note number not available" ELSE stLoggedUserSelectedJobSupplierId END}' style='{styles.sylTvInfo}' testId='tvQAInfo'/>
    </if>
    
</form>